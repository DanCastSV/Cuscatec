{% extends "base.html" %}

{% block content %}
<div class="container" style="max-width:700px;margin-top:30px;">
  <h3 class="text-center mb-3">Chat con Asistente Educativo</h3>
  <div id="chat-box" style="background:#f9f9f9;padding:12px;height:300px;overflow:auto;"></div>

  <div class="mt-3 d-flex">
    <input id="input-msg" class="form-control" placeholder="Escribe un mensaje..." />
    <button class="btn btn-primary" onclick="sendMsg()">Enviar</button>
  </div>
</div>

<script>
  const roomName = 'lobby';
  const loc = window.location;
  const scheme = loc.protocol === "https:" ? "wss" : "ws";
  const chatSocket = new WebSocket(`${scheme}://${loc.host}/ws/chat/${roomName}/`);

  const chatBox = document.getElementById("chat-box");
  const input = document.getElementById("input-msg");

  chatSocket.onopen = () => console.log('WS conectado:', roomName);
  chatSocket.onmessage = (e) => {
    const data = JSON.parse(e.data);
    const text = data.message || '';
    const p = document.createElement("p");
    p.innerHTML = `<b>Asistente:</b> ${text}`;
    p.style.background = "#e1f0ff";
    p.style.padding = "8px";
    p.style.borderRadius = "6px";
    p.style.marginBottom = "8px";
    chatBox.appendChild(p);
    chatBox.scrollTop = chatBox.scrollHeight;
  };
  chatSocket.onclose = () => console.log('WS cerrado');

  function sendMsg() {
    const mensaje = input.value.trim();
    if (!mensaje) return;
    // mostrar localmente
    const p = document.createElement("p");
    p.innerHTML = `<b>TÃº:</b> ${mensaje}`;
    p.style.background = "#d1ffd6";
    p.style.padding = "8px";
    p.style.borderRadius = "6px";
    p.style.marginBottom = "8px";
    chatBox.appendChild(p);
    chatBox.scrollTop = chatBox.scrollHeight;

    chatSocket.send(JSON.stringify({ message: mensaje }));
    input.value = "";
    input.focus();
  }

  input.addEventListener("keypress", function (e) {
    if (e.key === "Enter") sendMsg();
  });
</script>
{% endblock %}
