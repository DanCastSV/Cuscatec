{% extends "base.html" %}

{% load static %}

{% block content %}

<!-- Importar el CSS del chat -->
<link rel="stylesheet" href="{% static 'css/chat.css' %}">

<div class="container">
    <h3>Chat con Asistente Educativo</h3>

    <div id="chat-box"></div>

    <div class="chat-input">
        <input id="input-msg" class="form-control" placeholder="Escribe un mensaje..." />
        <button class="btn btn-primary" onclick="sendMsg()">Enviar</button>
    </div>
</div>

<script>
  const roomName = 'lobby';
  const loc = window.location;
  const scheme = loc.protocol === "https:" ? "wss" : "ws";
  const chatSocket = new WebSocket(`${scheme}://${loc.host}/ws/chat/${roomName}/`);

  const chatBox = document.getElementById("chat-box");
  const input = document.getElementById("input-msg");

  chatSocket.onopen = () => console.log('WS conectado:', roomName);

  chatSocket.onmessage = (e) => {
    const data = JSON.parse(e.data);
    const text = data.message || '';
    const p = document.createElement("p");

    p.innerHTML = `<b>Asistente:</b> ${text}`;
    p.classList.add("asistente");

    chatBox.appendChild(p);
    chatBox.scrollTop = chatBox.scrollHeight;
  };

  chatSocket.onclose = () => console.log('WS cerrado');

  function sendMsg() {
    const mensaje = input.value.trim();
    if (!mensaje) return;

    // mostrar localmente
    const p = document.createElement("p");
    p.innerHTML = `<b>TÃº:</b> ${mensaje}`;
    p.classList.add("usuario");

    chatBox.appendChild(p);
    chatBox.scrollTop = chatBox.scrollHeight;

    chatSocket.send(JSON.stringify({ message: mensaje }));
    input.value = "";
    input.focus();
  }

  input.addEventListener("keypress", function (e) {
    if (e.key === "Enter") sendMsg();
  });
</script>

{% endblock %}
